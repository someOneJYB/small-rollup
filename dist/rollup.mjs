var V=(n=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(n,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):n)(function(n){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+n+'" is not supported')});import*as te from"magic-string";import{dirname as he,resolve as fe}from"path";import le from"magic-string";function j(n){return n===" "||n==="	"||n===`
`||n==="\r"}function B(n){return n>="a"&&n<="z"||n>="A"&&n<="Z"}function k(n){return n>="0"&&n<="9"}function $(n){return n==="_"}var U=(l=>(l.Let="Let",l.Const="Const",l.Var="Var",l.Assign="Assign",l.Function="Function",l.Number="Number",l.Operator="Operator",l.Identifier="Identifier",l.LeftParen="LeftParen",l.RightParen="RightParen",l.LeftCurly="LeftCurly",l.RightCurly="RightCurly",l.Comma="Comma",l.Dot="Dot",l.Semicolon="Semicolon",l.StringLiteral="StringLiteral",l.Return="Return",l.Import="Import",l.Export="Export",l.Default="Default",l.From="From",l.As="As",l.Asterisk="Asterisk",l))(U||{}),ne=(i=>(i[i.Normal=0]="Normal",i[i.Identifier=1]="Identifier",i[i.StringLiteral=2]="StringLiteral",i[i.Number=3]="Number",i))(ne||{}),f={let(n){return{type:"Let",value:"let",start:n,end:n+3}},const(n){return{type:"Const",value:"const",start:n,end:n+5}},var(n){return{type:"Var",value:"var",start:n,end:n+3}},assign(n){return{type:"Assign",value:"=",start:n,end:n+1}},import(n){return{type:"Import",value:"import",start:n,end:n+6}},export(n){return{type:"Export",value:"export",start:n,end:n+6}},from(n){return{type:"From",value:"from",start:n,end:n+4}},as(n){return{type:"As",value:"as",start:n,end:n+2}},asterisk(n){return{type:"Asterisk",value:"*",start:n,end:n+1}},default(n){return{type:"Default",value:"default",start:n,end:n+7}},number(n,e){return{type:"Number",value:e,start:n,end:n+e.length,raw:e}},function(n){return{type:"Function",value:"function",start:n,end:n+8}},return(n){return{type:"Return",value:"return",start:n,end:n+6}},operator(n,e){return{type:"Operator",value:e,start:n,end:n+e.length}},comma(n){return{type:"Comma",value:",",start:n,end:n+1}},leftParen(n){return{type:"LeftParen",value:"(",start:n,end:n+1}},rightParen(n){return{type:"RightParen",value:")",start:n,end:n+1}},leftCurly(n){return{type:"LeftCurly",value:"{",start:n,end:n+1}},rightCurly(n){return{type:"RightCurly",value:"}",start:n,end:n+1}},dot(n){return{type:"Dot",value:".",start:n,end:n+1}},semicolon(n){return{type:"Semicolon",value:";",start:n,end:n+1}},stringLiteral(n,e,t){return{type:"StringLiteral",value:e,start:n,end:n+e.length+2,raw:t}},identifier(n,e){return{type:"Identifier",value:e,start:n,end:n+e.length}}},K=new Map([["(",f.leftParen],[")",f.rightParen],["{",f.leftCurly],["}",f.rightCurly],[".",f.dot],[";",f.semicolon],[",",f.comma],["*",f.asterisk],["=",f.assign]]),ie=["'",'"',"`"],G=["+","-","*","/","%","^","&","|","~","<<",">>"],S=class{constructor(e){this._tokens=[];this._currentIndex=0;this._scanMode=0;this._source=e}scanIndentifier(){this._setScanMode(1);let e="",t=this._getCurrentChar(),r=this._currentIndex;for(;B(t)||k(t)||$(t);)e+=t,this._currentIndex++,t=this._getCurrentChar();let i;e in f?i=f[e](r):i=f.identifier(r,e),this._tokens.push(i),this._resetScanMode()}scanStringLiteral(){this._setScanMode(2);let e=this._currentIndex,t=this._getCurrentChar(),r=t;this._currentIndex++;let i="";for(t=this._getCurrentChar();t&&t!==r;)i+=t,this._currentIndex++,t=this._getCurrentChar();let o=f.stringLiteral(e,i,`${r}${i}${r}`);this._tokens.push(o),this._resetScanMode()}_scanNumber(){this._setScanMode(3);let e=this._currentIndex,t="",r=this._getCurrentChar(),i=!1;for(;k(r)||r==="."&&!i;)r==="."&&(i=!0),t+=r,this._currentIndex++,r=this._getCurrentChar();if(i&&r===".")throw new Error('Unexpected character "."');let o=f.number(e,t);this._tokens.push(o),this._resetScanMode()}tokenize(){for(;this._currentIndex<this._source.length;){let e=this._source[this._currentIndex],t=this._currentIndex;if(j(e)){this._currentIndex++;continue}else if(B(e)){this.scanIndentifier();continue}else if(K.has(e)){if(e==="*"){let i=this._getPreviousToken();if(i.type!=="Import"&&i.type!=="Export"){this._tokens.push(f.operator(t,e)),this._currentIndex++;continue}}let r=K.get(e)(t);this._tokens.push(r),this._currentIndex++}else if(ie.includes(e)){this.scanStringLiteral(),this._currentIndex++;continue}else if(G.includes(e)&&this._scanMode===0){this._tokens.push(f.operator(t,e)),this._currentIndex++;continue}else if(G.includes(e+this._getNextChar())&&this._scanMode===0){this._tokens.push(f.operator(t,e+this._getNextChar())),this._currentIndex+=2;continue}else if(k(e)){this._scanNumber();continue}}return this._resetCurrentIndex(),this._getTokens()}_getCurrentChar(){return this._source[this._currentIndex]}_getNextChar(){return this._currentIndex+1<this._source.length?this._source[this._currentIndex+1]:""}_resetCurrentIndex(){this._currentIndex=0}_getTokens(){return this._tokens}_getPreviousToken(){if(this._tokens.length>0)return this._tokens[this._tokens.length-1];throw new Error("Previous token not found")}_setScanMode(e){this._scanMode=e}_resetScanMode(){this._scanMode=0}};var D=(p=>(p.Program="Program",p.VariableDeclaration="VariableDeclaration",p.FunctionDeclaration="FunctionDeclaration",p.Identifier="Identifier",p.BlockStatement="BlockStatement",p.ExpressionStatement="ExpressionStatement",p.ReturnStatement="ReturnStatement",p.CallExpression="CallExpression",p.BinaryExpression="BinaryExpression",p.MemberExpression="MemberExpression",p.FunctionExpression="FunctionExpression",p.Literal="Literal",p.ImportDeclaration="ImportDeclaration",p.ImportSpecifier="ImportSpecifier",p.ImportDefaultSpecifier="ImportDefaultSpecifier",p.ImportNamespaceSpecifier="ImportNamespaceSpecifier",p.ExportDeclaration="ExportDeclaration",p.ExportSpecifier="ExportSpecifier",p.ExportDefaultDeclaration="ExportDefaultDeclaration",p.ExportNamedDeclaration="ExportNamedDeclaration",p.ExportAllDeclaration="ExportAllDeclaration",p.VariableDeclarator="VariableDeclarator",p))(D||{}),z=(t=>(t[t.FunctionDeclaration=0]="FunctionDeclaration",t[t.CallExpression=1]="CallExpression",t))(z||{});var b=class{constructor(e){this._tokens=[];this._currentIndex=0;this._tokens=[...e]}parse(){return this._parseProgram()}_parseProgram(){let e={type:"Program",body:[],start:0,end:1/0};for(;!this._isEnd();){let t=this._parseStatement();e.body.push(t),this._isEnd()&&(e.end=t.end)}return e}_parseStatement(){if(this._checkCurrentTokenType("Function"))return this._parseFunctionDeclaration();if(this._checkCurrentTokenType("Identifier"))return this._parseExpressionStatement();if(this._checkCurrentTokenType("LeftCurly"))return this._parseBlockStatement();if(this._checkCurrentTokenType("Return"))return this._parseReturnStatement();if(this._checkCurrentTokenType("Import"))return this._parseImportStatement();if(this._checkCurrentTokenType("Export"))return this._parseExportStatement();if(this._checkCurrentTokenType(["Let","Var","Const"]))return this._parseVariableDeclaration();throw console.log(this._getCurrentToken()),new Error("Unexpected token")}_parseImportStatement(){let{start:e}=this._getCurrentToken(),t=[];if(this._goNext("Import"),this._checkCurrentTokenType("Identifier")){let o=this._parseIdentifier(),s={type:"ImportDefaultSpecifier",local:o,start:o.start,end:o.end};t.push(s),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}if(this._checkCurrentTokenType("LeftCurly")){for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let o=this._parseIdentifier(),s=null;this._checkCurrentTokenType("As")&&(this._goNext("As"),s=this._parseIdentifier());let a={type:"ImportSpecifier",imported:o,local:s||o,start:o.start,end:s?s.end:o.end};t.push(a),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}this._goNext("RightCurly")}else if(this._checkCurrentTokenType("Asterisk")){let{start:o}=this._getCurrentToken();this._goNext("Asterisk"),this._goNext("As");let s=this._parseIdentifier(),a={type:"ImportNamespaceSpecifier",local:s,start:o,end:s.end};t.push(a)}this._checkCurrentTokenType("From")&&this._goNext("From");let r=this._parseLiteral(),i={type:"ImportDeclaration",specifiers:t,start:e,end:r.end,source:r};return this._skipSemicolon(),i}_parseExportStatement(){let{start:e}=this._getCurrentToken(),t=null,r=[];if(this._goNext("Export"),this._checkCurrentTokenType("Default")){if(this._goNext("Default"),this._checkCurrentTokenType("Identifier")){let i=this._parseExpression();t={type:"ExportDefaultDeclaration",declaration:i,start:i.start,end:i.end}}else if(this._checkCurrentTokenType("Function")){let i=this._parseFunctionDeclaration();t={type:"ExportDefaultDeclaration",declaration:i,start:e,end:i.end}}}else if(this._checkCurrentTokenType("LeftCurly")){for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let o=this._parseIdentifier(),s=o;this._checkCurrentTokenType("As")&&(this._goNext("As"),s=this._parseIdentifier());let a={type:"ExportSpecifier",local:o,exported:s,start:o.start,end:s.end};r.push(a),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}this._goNext("RightCurly"),this._checkCurrentTokenType("From")&&this._goNext("From");let i=this._parseLiteral();t={type:"ExportNamedDeclaration",specifiers:r,start:e,declaration:null,end:i.end,source:i}}else if(this._checkCurrentTokenType(["Const","Let","Var"])){let i=this._parseVariableDeclaration();return t={type:"ExportNamedDeclaration",declaration:i,start:e,end:i.end,specifiers:r,source:null},t}else if(this._checkCurrentTokenType("Function")){let i=this._parseFunctionDeclaration();t={type:"ExportNamedDeclaration",declaration:i,start:e,end:i.end,specifiers:r,source:null}}else{this._goNext("Asterisk");let i=null;this._checkCurrentTokenType("As")&&(this._goNext("As"),i=this._parseIdentifier()),this._goNext("From");let o=this._parseLiteral();t={type:"ExportAllDeclaration",start:e,end:o.end,source:o,exported:i}}if(!t)throw new Error("Export declaration cannot be parsed");return this._skipSemicolon(),t}_parseVariableDeclaration(){let{start:e}=this._getCurrentToken(),t=this._getCurrentToken().value;this._goNext(["Let","Var","Const"]);let r=[],i=()=>{if(this._checkCurrentTokenType("Semicolon"))return!0;let s=this._getNextToken();return!(s&&s.type==="Assign")};for(;!i();){let s=this._parseIdentifier(),a=null;this._checkCurrentTokenType("Assign")&&(this._goNext("Assign"),this._checkCurrentTokenType(["Number","StringLiteral"])?a=this._parseLiteral():a=this._parseExpression());let c={type:"VariableDeclarator",id:s,init:a,start:s.start,end:a?a.end:s.end};r.push(c),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}let o={type:"VariableDeclaration",kind:t,declarations:r,start:e,end:this._getPreviousToken().end};return this._skipSemicolon(),o}_parseReturnStatement(){let{start:e}=this._getCurrentToken();this._goNext("Return");let t=this._parseExpression(),r={type:"ReturnStatement",argument:t,start:e,end:t.end};return this._skipSemicolon(),r}_parseExpressionStatement(){let e=this._parseExpression();return{type:"ExpressionStatement",expression:e,start:e.start,end:e.end}}_parseExpression(){if(this._checkCurrentTokenType("Function"))return this._parseFunctionExpression();if(this._checkCurrentTokenType(["Number","StringLiteral"]))return this._parseLiteral();let e=this._parseIdentifier();for(;!this._isEnd();)if(this._checkCurrentTokenType("LeftParen"))e=this._parseCallExpression(e);else if(this._checkCurrentTokenType("Dot"))e=this._parseMemberExpression(e);else if(this._checkCurrentTokenType("Operator"))e=this.__parseBinaryOperatorExpression(e);else break;return e}__parseBinaryOperatorExpression(e){let{start:t}=this._getCurrentToken(),r=this._getCurrentToken().value;this._goNext("Operator");let i=this._parseExpression();return{type:"BinaryExpression",operator:r,left:e,right:i,start:t,end:i.end}}_parseMemberExpression(e){this._goNext("Dot");let t=this._parseIdentifier();return{type:"MemberExpression",object:e,property:t,start:e.start,end:t.end,computed:!1}}_parseCallExpression(e){let t=this._parseParams(1),{end:r}=this._getPreviousToken(),i={type:"CallExpression",callee:e,arguments:t,start:e.start,end:r};return this._skipSemicolon(),i}_parseFunctionDeclaration(){let{start:e}=this._getCurrentToken();this._goNext("Function");let t=null;this._checkCurrentTokenType("Identifier")&&(t=this._parseIdentifier());let r=this._parseParams(),i=this._parseBlockStatement();return{type:"FunctionDeclaration",id:t,params:r,body:i,start:e,end:i.end}}_parseFunctionExpression(){let{start:e}=this._getCurrentToken();this._goNext("Function");let t=null;this._checkCurrentTokenType("Identifier")&&(t=this._parseIdentifier());let r=this._parseParams(),i=this._parseBlockStatement();return{type:"FunctionExpression",id:t,params:r,body:i,start:e,end:i.end}}_parseParams(e=0){this._goNext("LeftParen");let t=[];for(;!this._checkCurrentTokenType("RightParen");){let r=e===0?this._parseIdentifier():this._parseExpression();t.push(r),this._checkCurrentTokenType("RightParen")||this._goNext("Comma")}return this._goNext("RightParen"),t}_parseLiteral(){let e=this._getCurrentToken(),t=e.value;e.type==="Number"&&(t=Number(t));let r={type:"Literal",value:e.value,start:e.start,end:e.end,raw:e.raw};return this._goNext(e.type),r}_parseIdentifier(){let e=this._getCurrentToken(),t={type:"Identifier",name:e.value,start:e.start,end:e.end};return this._goNext("Identifier"),t}_parseBlockStatement(){let{start:e}=this._getCurrentToken(),t={type:"BlockStatement",body:[],start:e,end:1/0};for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let r=this._parseStatement();t.body.push(r)}return t.end=this._getCurrentToken().end,this._goNext("RightCurly"),t}_checkCurrentTokenType(e){if(this._isEnd())return!1;let t=this._tokens[this._currentIndex];return Array.isArray(e)?e.includes(t.type):t.type===e}_skipSemicolon(){this._checkCurrentTokenType("Semicolon")&&this._goNext("Semicolon")}_goNext(e){let t=this._tokens[this._currentIndex];if(Array.isArray(e)){if(!e.includes(t.type))throw new Error(`Expect ${e.join(",")}, but got ${t.type}`)}else if(t.type!==e)throw new Error(`Expect ${e}, but got ${t.type}`);return this._currentIndex++,t}_isEnd(){return this._currentIndex>=this._tokens.length}_getCurrentToken(){return this._tokens[this._currentIndex]}_getPreviousToken(){return this._tokens[this._currentIndex-1]}_getNextToken(){return this._currentIndex+1<this._tokens.length?this._tokens[this._currentIndex+1]:!1}};function W(n){let t=new S(n).tokenize();return new b(t).parse()}var m=Object.keys,L=Object.values;var x=class{constructor(e,t,r){this.isFunctionDeclaration=!1;this.name=null;this.isParam=!1;this.isUsed=!1;this.isReassigned=!1;e&&(e.type==="FunctionDeclaration"?(this.isFunctionDeclaration=!0,this.functionNode=e):e.type==="VariableDeclarator"&&e.init&&/FunctionExpression/.test(e.init.type)&&(this.isFunctionDeclaration=!0,this.functionNode=e.init)),this.statement=r,this.isParam=t}addReference(e){e.declaration=this,this.name=e.name}use(){this.isUsed=!0,this.statement&&this.statement.mark()}render(){return this.name}},I=class extends x{constructor(t,r,i){super(t,!1,i);this.original=null,this.exportName="",this.name=r}render(){var t;return((t=this.original)==null?void 0:t.render())||this.name}bind(t){this.original=t}},N=class extends x{constructor(t){super(null,!1,null);this.originals={};this.needsNamespaceBlock=!1;this.module=t,t.getExports().forEach(r=>{let i=t.traceExport(r);i&&(this.originals[r]=i)})}addReference(t){if(this.needsNamespaceBlock||(this.needsNamespaceBlock=!0),t.objectPaths.length){let r=t.objectPaths.shift();t.name=r.name,t.start=r.start,t.end=r.end}L(this.originals).forEach(r=>{r.addReference(t)}),super.addReference(t)}renderBlock(t="  "){let r=m(this.originals).map(i=>{let o=this.originals[i];return`${t}${i}: ${o.render()}`}).join(`,
`);return`const ${this.render()} = Object.freeze({
${r}
});`}use(){for(let t of L(this.originals))t.use()}};var g=class{constructor(e){this.declarations={};let{parent:t,paramNodes:r,block:i,statement:o}=e;this.parent=t,this.paramNodes=r||[],this.statement=o,this.isBlockScope=!!i,this.paramNodes.forEach(s=>this.declarations[s.name]=new x(s,!0,this.statement))}addDeclaration(e,t){if(this.isBlockScope&&!t&&this.parent){this.parent.addDeclaration(e,t);return}let r=e.id&&e.id.name;this.declarations[r]=new x(e,!1,this.statement)}eachDeclaration(e){m(this.declarations).forEach(t=>{e(t,this.declarations[t])})}contains(e){return this.findDeclaration(e)}findDeclaration(e){return this.declarations[e]||this.parent&&this.parent.findDeclaration(e)}};function q(n){return n?n.type==="FunctionDeclaration"||n.type==="VariableDeclarator"&&n.init&&n.init.type==="FunctionExpression"||(n.type==="ExportNamedDeclaration"||n.type==="ExportDefaultDeclaration")&&!!n.declaration&&n.declaration.type==="FunctionDeclaration":!1}function J(n){return/^Export/.test(n.type)}function Q(n){return n.type==="ImportDeclaration"}var A,y;function T(n,{enter:e,leave:t}){y=!1,P(n,null,e,t)}var oe={skip:()=>A=!0,abort:()=>y=!0},H={},se=Object.prototype.toString;function ae(n){return se.call(n)==="[object Array]"}function P(n,e,t,r,i){if(!n||y||t&&(A=!1,t.call(oe,n,e,i),A||y))return;let o=H[n.type]||(H[n.type]=Object.keys(n).filter(c=>typeof n[c]=="object")),s,a;for(let c=0;c<o.length;c++)if(s=o[c],a=n[s],ae(a))for(let h=0;h<a.length;h++)P(a[h],n,t,r,s);else a&&a.type&&P(a,n,t,r,s);r&&!y&&r(n,e,i)}function Z(n){let{node:e,scope:t}=n,r=t;T(e,{enter(i){if(i.type==="FunctionDeclaration"&&r.addDeclaration(i,!1),i.type==="VariableDeclaration"){let s=i,a=s.kind!=="var";s.declarations.forEach(c=>{r.addDeclaration(c,a)})}let o;if(i.type==="FunctionDeclaration"){let s=i;o=new g({parent:r,block:!1,paramNodes:s.params,statement:n})}i.type==="BlockStatement"&&(o=new g({parent:r,block:!0,statement:n})),o&&(Object.defineProperty(i,"_scope",{value:o,configurable:!0}),r=o)},leave(i){i._scope&&r.parent&&(r=r.parent)}})}var C=class{constructor(e,t,r){this.declaration=null;this.objectPaths=[];this.node=e,this.scope=t,this.statement=r,this.start=e.start,this.end=e.end;let i=e;for(this.objectPaths=[];i.type==="MemberExpression";)this.objectPaths.unshift(i.property),i=i.object;this.objectPaths.unshift(i),this.name=i.name}};function ce(n,e){return n.type==="MemberExpression"&&e.type!=="MemberExpression"?!0:n.type==="Identifier"?!(e.type==="ExportSpecifier"&&n!==e.local):!1}function X(n){let{references:e,scope:t,node:r}=n,i=t;T(r,{enter(o,s){if(o._scope&&(i=o._scope),ce(o,s)){let a=new C(o,i,n);e.push(a)}},leave(o){o._scope&&i.parent&&(i=i.parent)}})}var Et=V("flatted"),M=class{constructor(e,t,r){this.isIncluded=!1;this.defines=new Set;this.modifies=new Set;this.dependsOn=new Set;this.references=[];this.magicString=t,this.node=e,this.module=r,this.scope=new g({statement:this}),this.start=e.start,this.next=0,this.isImportDeclaration=Q(e),this.isExportDeclaration=J(e),this.isReexportDeclaration=this.isExportDeclaration&&!!e.source,this.isFunctionDeclaration=q(e)}analyse(){this.isImportDeclaration||(Z(this),X(this))}mark(){this.isIncluded||(this.isIncluded=!0,this.references.forEach(e=>e.declaration&&e.declaration.use()))}};var v=class{constructor({path:e,bundle:t,code:r,loader:i,isEntry:o=!1}){this.isEntry=!1;this.exportAllSources=[];this.exportAllModules=[];this.dependencies=[];this.dependencyModules=[];this.referencedModules=[];this.id=e,this.bundle=t,this.moduleLoader=i,this.isEntry=o,this.path=e,this.code=r,this.magicString=new le(r),this.imports={},this.exports={},this.reexports={},this.declarations={};try{let a=W(r).body;this.statements=a.map(c=>{let h=this.magicString.snip(c.start,c.end);return new M(c,h,this)})}catch(s){throw console.log(s),s}this.analyseAST()}analyseAST(){this.statements.forEach(r=>{r.analyse(),r.isImportDeclaration?(console.log(r,"import type"),this.addImports(r)):r.isExportDeclaration&&this.addExports(r),r.scope.parent||r.scope.eachDeclaration((i,o)=>{this.declarations[i]=o})});let e=this.statements,t=this.code.length;for(let r=e.length-1;r>=0;r--)e[r].next=t,t=e[r].start;console.log("module:",this.path),console.log("declaration\uFF1A",this.declarations),console.log("****************************"),this.statements.forEach(r=>{r.references.forEach(i=>{i.name})})}addDependencies(e){this.dependencies.includes(e)||this.dependencies.push(e)}addImports(e){let t=e.node,r=t.source.value;console.log("00000000"),console.log(r),console.log("00000000"),t.specifiers.forEach(i=>{let o=i.type==="ImportDefaultSpecifier",s=i.type==="ImportNamespaceSpecifier",a=i.local.name,c=o?"default":s?"*":i.imported.name;this.imports[a]={source:r,name:c,localName:a}}),console.log(this.imports,"\u6536\u96C6 imports"),this.addDependencies(r)}addExports(e){let t=e.node,r=t.source&&t.source.value;if(t.type==="ExportNamedDeclaration")if(t.specifiers.length)t.specifiers.forEach(i=>{let o=i.local.name,s=i.exported.name;this.exports[s]={localName:o,name:s},r&&(this.reexports[o]={statement:e,source:r,localName:o,name:o,module:void 0},this.imports[o]={source:r,localName:o,name:o},this.addDependencies(r))});else{let i=t.declaration,o;i.type==="VariableDeclaration"?o=i.declarations[0].id.name:o=i.id.name,this.exports[o]={statement:e,localName:o,name:o}}else if(t.type==="ExportDefaultDeclaration"){let i=t.declaration.id&&t.declaration.id.name||t.declaration.name;this.exports.default={statement:e,localName:i,name:"default"},this.declarations.default=new I(t,i,e)}else t.type==="ExportAllDeclaration"&&r&&(this.exportAllSources.push(r),this.addDependencies(r))}bind(){this.bindImportSpecifiers(),this.bindReferences()}bindImportSpecifiers(){[...Object.values(this.imports),...Object.values(this.reexports)].forEach(e=>{e.module=this._getModuleBySource(e.source)}),this.exportAllModules=this.exportAllSources.map(this._getModuleBySource.bind(this)),this.dependencyModules=this.dependencies.map(this._getModuleBySource.bind(this)),this.dependencyModules.forEach(e=>{e.referencedModules.push(this)})}bindReferences(){if(this.declarations.default&&this.exports.default.localName){let e=this.trace(this.exports.default.localName);e&&this.declarations.default.bind(e)}this.statements.forEach(e=>{e.references.forEach(t=>{let r=t.scope.findDeclaration(t.name)||this.trace(t.name);r&&r.addReference(t)})})}getOrCreateNamespace(){return this.declarations["*"]||(this.declarations["*"]=new N(this)),this.declarations["*"]}trace(e){if(this.declarations[e])return this.declarations[e];if(this.imports[e]){let t=this.imports[e],r=t.module;if(t.name==="*")return r.getOrCreateNamespace();let i=r.traceExport(t.name);if(i)return i}return null}traceExport(e){let t=this.reexports[e];if(t){let i=t.module.traceExport(t.localName);if(!i)throw new Error(`${t.localName} is not exported by module ${t.module.path}(imported by ${this.path})`);return i}if(this.exports[e]){let i=this.trace(e);if(i)return i}for(let i of this.exportAllModules){let o=i.trace(e);if(o)return o}return null}render(){let e=this.magicString.clone().trim();if(this.statements.forEach(t=>{if(!t.isIncluded){e.remove(t.start,t.next);return}if(t.references.forEach(r=>{let{start:i,end:o}=r,s=r.declaration;if(s){let a=s.render();e.overwrite(i,o,a)}}),t.isExportDeclaration&&!this.isEntry){if(t.node.type==="ExportNamedDeclaration"&&t.node.specifiers.length)e.remove(t.start,t.next);else if(t.node.type==="ExportNamedDeclaration"&&(t.node.declaration.type==="VariableDeclaration"||t.node.declaration.type==="FunctionDeclaration"))e.remove(t.node.start,t.node.declaration.start);else if(t.node.type==="ExportAllDeclaration")e.remove(t.start,t.next);else if(t.node.type==="ExportDefaultDeclaration"){let i=this.declarations.default.render();t.node.declaration.type==="FunctionDeclaration"?t.node.declaration.id?e.overwrite(t.node.start,t.node.declaration.start,`const ${i} = `):e.overwrite(t.node.start,t.node.declaration.start+8,`function ${i}`):e.overwrite(t.node.start,t.node.declaration.start,`const ${i} = `)}}}),this.declarations["*"]){let t=this.declarations["*"];t.needsNamespaceBlock&&e.append(`

${t.renderBlock()}
`)}return e.trim()}getExports(){return[...m(this.exports),...m(this.reexports),...this.exportAllModules.map(e=>e.getExports().filter(t=>t!=="default")).flat()]}_getModuleBySource(e){let t=this.moduleLoader.resolveId(e,this.path);return this.bundle.getModuleById(t)}};import{dirname as pe,isAbsolute as ue,resolve as Y,extname as At}from"path";function ee(n,e){return ue(n)?n:n.startsWith(".")?e?Y(pe(e),n):Y(n):!1}import{readFile as de}from"fs/promises";var w=class{constructor(e){this.resolveIdsMap=new Map;this.bundle=e}resolveId(e,t){let r=e+t;if(this.resolveIdsMap.has(r))return this.resolveIdsMap.get(r);let i=ee(e,t);return this.resolveIdsMap.set(r,i),i}async fetchModule(e,t,r=!1,i=this.bundle,o=this){let s=this.resolveId(e,t);if(s===!1)return null;let a=this.bundle.getModuleById(s);if(a)return a;let c=await de(s,{encoding:"utf-8"}),h=new v({path:s,code:c,bundle:i,loader:o,isEntry:r});return this.bundle.addModule(h),await this.fetchAllDependencies(h),h}async fetchAllDependencies(e){await Promise.all(e.dependencies.map(t=>this.fetchModule(t,e.path)))}};var Gt=V("flatted"),R=class{constructor(e){this.statements=[];this.modules=[];this.moduleById={};this.resolveIds={};this.orderedModules=[];let{entry:t,bundle:r}=e;this.entryPath=fe(t),this.basedir=he(this.entryPath),this.bundle=r,this.moduleLoader=new w(r)}async build(){let e=await this.moduleLoader.fetchModule(this.entryPath,null,!0);this.modules.forEach(r=>r.bind()),this.orderedModules=this.sortModules(e),e.getExports().forEach(r=>{e.traceExport(r).use()}),this.modules.forEach(r=>{console.log("path:",r.path),console.log("decration deal:",r.declarations)}),this.doconflict();function t(r,i=2){let o=new WeakSet;return JSON.stringify(r,(s,a)=>{if(typeof a=="object"&&a!==null){if(o.has(a))return"[Circular Reference]";o.add(a)}return typeof a=="bigint"?a.toString()+"n":a instanceof Error?a.stack:a instanceof Map?Object.fromEntries(a):a instanceof Set?[...a]:a instanceof Date?a.toISOString():a},i)}}doconflict(){let e={};function t(r){let i=r,o=1;for(;e[i];)i=`${r}$${o++}`;return e[i]=!0,i}this.modules.forEach(r=>{m(r.declarations).forEach(i=>{let o=r.declarations[i];o.name=t(o.name)})})}getModuleById(e){return this.moduleById[e]}addModule(e){this.moduleById[e.id]||(this.moduleById[e.id]=e,this.modules.push(e))}sortModules(e){let t=[],r={},i={},o=[];function s(c,h){let _=[c],E=h;for(;E!==c;)_.push(E),E=i[E];return _.push(_[0]),_.reverse()}function a(c){if(!r[c.id]){for(let h of c.dependencyModules){if(i[h.id]){r[h.id]||o.push(s(h.id,c.id));continue}i[h.id]=c.id,a(h)}r[c.id]=!0,t.push(c)}}return a(e),o.length&&(o.forEach(c=>{console.log(c)}),process.exit(1)),t}};var F=class{constructor(e){this.graph=new R({entry:e.entry,bundle:this})}async build(){await this.graph.build()}getModuleById(e){return this.graph.getModuleById(e)}addModule(e){return this.graph.addModule(e)}render(){let e=new te.Bundle({separator:`
`});this.graph.orderedModules.forEach(r=>{e.addSource({content:r.render()})});let t=e.generateMap({includeContent:!0});return{code:e.toString(),map:t}}};import O from"fs";import{dirname as me}from"path";var xe=n=>O.existsSync(n),ge=n=>new Promise((e,t)=>{let r=n.substring(0,n.lastIndexOf("/"));O.mkdir(r,{recursive:!0},i=>{i?t({success:!1}):e({success:!0})})}),re=(n,e,t="utf-8")=>new Promise((r,i)=>{O.writeFile(n,e,{mode:438,flag:"w+",encoding:t},o=>{o?i({success:!1,data:o}):r({success:!0,data:{path:n,content:e}})})});function Xt(n){let{input:e="./index.js",output:t="./dist/index.js"}=n,r=new F({entry:e});return r.build().then(()=>{let i=()=>r.render();return{generate:i,write:async()=>{let{code:o,map:s}=i();return xe(me(t))||await ge(t),Promise.all([re(t,o),re(t+".map",s.toString())])}}})}export{z as FunctionType,D as NodeType,ne as ScanMode,U as TokenType,S as Tokenizer,W as parse,Xt as rollup};
