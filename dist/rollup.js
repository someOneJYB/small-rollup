"use strict";var le=Object.create;var D=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty;var fe=(r,e)=>{for(var t in e)D(r,t,{get:e[t],enumerable:!0})},z=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ue(e))!he.call(r,i)&&i!==t&&D(r,i,{get:()=>e[i],enumerable:!(n=pe(e,i))||n.enumerable});return r};var P=(r,e,t)=>(t=r!=null?le(de(r)):{},z(e||!r||!r.__esModule?D(t,"default",{value:r,enumerable:!0}):t,r)),me=r=>z(D({},"__esModule",{value:!0}),r);var be={};fe(be,{FunctionType:()=>j,NodeType:()=>_,ScanMode:()=>H,TokenType:()=>V,Tokenizer:()=>y,parse:()=>$,rollup:()=>De});module.exports=me(be);var se=P(require("magic-string"));var B=require("path");var ne=P(require("magic-string"));function W(r){return r===" "||r==="	"||r===`
`||r==="\r"}function O(r){return r>="a"&&r<="z"||r>="A"&&r<="Z"}function b(r){return r>="0"&&r<="9"}function q(r){return r==="_"}var V=(l=>(l.Let="Let",l.Const="Const",l.Var="Var",l.Assign="Assign",l.Function="Function",l.Number="Number",l.Operator="Operator",l.Identifier="Identifier",l.LeftParen="LeftParen",l.RightParen="RightParen",l.LeftCurly="LeftCurly",l.RightCurly="RightCurly",l.Comma="Comma",l.Dot="Dot",l.Semicolon="Semicolon",l.StringLiteral="StringLiteral",l.Return="Return",l.Import="Import",l.Export="Export",l.Default="Default",l.From="From",l.As="As",l.Asterisk="Asterisk",l))(V||{}),H=(i=>(i[i.Normal=0]="Normal",i[i.Identifier=1]="Identifier",i[i.StringLiteral=2]="StringLiteral",i[i.Number=3]="Number",i))(H||{}),h={let(r){return{type:"Let",value:"let",start:r,end:r+3}},const(r){return{type:"Const",value:"const",start:r,end:r+5}},var(r){return{type:"Var",value:"var",start:r,end:r+3}},assign(r){return{type:"Assign",value:"=",start:r,end:r+1}},import(r){return{type:"Import",value:"import",start:r,end:r+6}},export(r){return{type:"Export",value:"export",start:r,end:r+6}},from(r){return{type:"From",value:"from",start:r,end:r+4}},as(r){return{type:"As",value:"as",start:r,end:r+2}},asterisk(r){return{type:"Asterisk",value:"*",start:r,end:r+1}},default(r){return{type:"Default",value:"default",start:r,end:r+7}},number(r,e){return{type:"Number",value:e,start:r,end:r+e.length,raw:e}},function(r){return{type:"Function",value:"function",start:r,end:r+8}},return(r){return{type:"Return",value:"return",start:r,end:r+6}},operator(r,e){return{type:"Operator",value:e,start:r,end:r+e.length}},comma(r){return{type:"Comma",value:",",start:r,end:r+1}},leftParen(r){return{type:"LeftParen",value:"(",start:r,end:r+1}},rightParen(r){return{type:"RightParen",value:")",start:r,end:r+1}},leftCurly(r){return{type:"LeftCurly",value:"{",start:r,end:r+1}},rightCurly(r){return{type:"RightCurly",value:"}",start:r,end:r+1}},dot(r){return{type:"Dot",value:".",start:r,end:r+1}},semicolon(r){return{type:"Semicolon",value:";",start:r,end:r+1}},stringLiteral(r,e,t){return{type:"StringLiteral",value:e,start:r,end:r+e.length+2,raw:t}},identifier(r,e){return{type:"Identifier",value:e,start:r,end:r+e.length}}},J=new Map([["(",h.leftParen],[")",h.rightParen],["{",h.leftCurly],["}",h.rightCurly],[".",h.dot],[";",h.semicolon],[",",h.comma],["*",h.asterisk],["=",h.assign]]),xe=["'",'"',"`"],Q=["+","-","*","/","%","^","&","|","~","<<",">>"],y=class{constructor(e){this._tokens=[];this._currentIndex=0;this._scanMode=0;this._source=e}scanIndentifier(){this._setScanMode(1);let e="",t=this._getCurrentChar(),n=this._currentIndex;for(;O(t)||b(t)||q(t);)e+=t,this._currentIndex++,t=this._getCurrentChar();let i;e in h?i=h[e](n):i=h.identifier(n,e),this._tokens.push(i),this._resetScanMode()}scanStringLiteral(){this._setScanMode(2);let e=this._currentIndex,t=this._getCurrentChar(),n=t;this._currentIndex++;let i="";for(t=this._getCurrentChar();t&&t!==n;)i+=t,this._currentIndex++,t=this._getCurrentChar();let o=h.stringLiteral(e,i,`${n}${i}${n}`);this._tokens.push(o),this._resetScanMode()}_scanNumber(){this._setScanMode(3);let e=this._currentIndex,t="",n=this._getCurrentChar(),i=!1;for(;b(n)||n==="."&&!i;)n==="."&&(i=!0),t+=n,this._currentIndex++,n=this._getCurrentChar();if(i&&n===".")throw new Error('Unexpected character "."');let o=h.number(e,t);this._tokens.push(o),this._resetScanMode()}tokenize(){for(;this._currentIndex<this._source.length;){let e=this._source[this._currentIndex],t=this._currentIndex;if(W(e)){this._currentIndex++;continue}else if(O(e)){this.scanIndentifier();continue}else if(J.has(e)){if(e==="*"){let i=this._getPreviousToken();if(i.type!=="Import"&&i.type!=="Export"){this._tokens.push(h.operator(t,e)),this._currentIndex++;continue}}let n=J.get(e)(t);this._tokens.push(n),this._currentIndex++}else if(xe.includes(e)){this.scanStringLiteral(),this._currentIndex++;continue}else if(Q.includes(e)&&this._scanMode===0){this._tokens.push(h.operator(t,e)),this._currentIndex++;continue}else if(Q.includes(e+this._getNextChar())&&this._scanMode===0){this._tokens.push(h.operator(t,e+this._getNextChar())),this._currentIndex+=2;continue}else if(b(e)){this._scanNumber();continue}}return this._resetCurrentIndex(),this._getTokens()}_getCurrentChar(){return this._source[this._currentIndex]}_getNextChar(){return this._currentIndex+1<this._source.length?this._source[this._currentIndex+1]:""}_resetCurrentIndex(){this._currentIndex=0}_getTokens(){return this._tokens}_getPreviousToken(){if(this._tokens.length>0)return this._tokens[this._tokens.length-1];throw new Error("Previous token not found")}_setScanMode(e){this._scanMode=e}_resetScanMode(){this._scanMode=0}};var _=(p=>(p.Program="Program",p.VariableDeclaration="VariableDeclaration",p.FunctionDeclaration="FunctionDeclaration",p.Identifier="Identifier",p.BlockStatement="BlockStatement",p.ExpressionStatement="ExpressionStatement",p.ReturnStatement="ReturnStatement",p.CallExpression="CallExpression",p.BinaryExpression="BinaryExpression",p.MemberExpression="MemberExpression",p.FunctionExpression="FunctionExpression",p.Literal="Literal",p.ImportDeclaration="ImportDeclaration",p.ImportSpecifier="ImportSpecifier",p.ImportDefaultSpecifier="ImportDefaultSpecifier",p.ImportNamespaceSpecifier="ImportNamespaceSpecifier",p.ExportDeclaration="ExportDeclaration",p.ExportSpecifier="ExportSpecifier",p.ExportDefaultDeclaration="ExportDefaultDeclaration",p.ExportNamedDeclaration="ExportNamedDeclaration",p.ExportAllDeclaration="ExportAllDeclaration",p.VariableDeclarator="VariableDeclarator",p))(_||{}),j=(t=>(t[t.FunctionDeclaration=0]="FunctionDeclaration",t[t.CallExpression=1]="CallExpression",t))(j||{});var I=class{constructor(e){this._tokens=[];this._currentIndex=0;this._tokens=[...e]}parse(){return this._parseProgram()}_parseProgram(){let e={type:"Program",body:[],start:0,end:1/0};for(;!this._isEnd();){let t=this._parseStatement();e.body.push(t),this._isEnd()&&(e.end=t.end)}return e}_parseStatement(){if(this._checkCurrentTokenType("Function"))return this._parseFunctionDeclaration();if(this._checkCurrentTokenType("Identifier"))return this._parseExpressionStatement();if(this._checkCurrentTokenType("LeftCurly"))return this._parseBlockStatement();if(this._checkCurrentTokenType("Return"))return this._parseReturnStatement();if(this._checkCurrentTokenType("Import"))return this._parseImportStatement();if(this._checkCurrentTokenType("Export"))return this._parseExportStatement();if(this._checkCurrentTokenType(["Let","Var","Const"]))return this._parseVariableDeclaration();throw console.log(this._getCurrentToken()),new Error("Unexpected token")}_parseImportStatement(){let{start:e}=this._getCurrentToken(),t=[];if(this._goNext("Import"),this._checkCurrentTokenType("Identifier")){let o=this._parseIdentifier(),s={type:"ImportDefaultSpecifier",local:o,start:o.start,end:o.end};t.push(s),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}if(this._checkCurrentTokenType("LeftCurly")){for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let o=this._parseIdentifier(),s=null;this._checkCurrentTokenType("As")&&(this._goNext("As"),s=this._parseIdentifier());let a={type:"ImportSpecifier",imported:o,local:s||o,start:o.start,end:s?s.end:o.end};t.push(a),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}this._goNext("RightCurly")}else if(this._checkCurrentTokenType("Asterisk")){let{start:o}=this._getCurrentToken();this._goNext("Asterisk"),this._goNext("As");let s=this._parseIdentifier(),a={type:"ImportNamespaceSpecifier",local:s,start:o,end:s.end};t.push(a)}this._checkCurrentTokenType("From")&&this._goNext("From");let n=this._parseLiteral(),i={type:"ImportDeclaration",specifiers:t,start:e,end:n.end,source:n};return this._skipSemicolon(),i}_parseExportStatement(){let{start:e}=this._getCurrentToken(),t=null,n=[];if(this._goNext("Export"),this._checkCurrentTokenType("Default")){if(this._goNext("Default"),this._checkCurrentTokenType("Identifier")){let i=this._parseExpression();t={type:"ExportDefaultDeclaration",declaration:i,start:i.start,end:i.end}}else if(this._checkCurrentTokenType("Function")){let i=this._parseFunctionDeclaration();t={type:"ExportDefaultDeclaration",declaration:i,start:e,end:i.end}}}else if(this._checkCurrentTokenType("LeftCurly")){for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let o=this._parseIdentifier(),s=o;this._checkCurrentTokenType("As")&&(this._goNext("As"),s=this._parseIdentifier());let a={type:"ExportSpecifier",local:o,exported:s,start:o.start,end:s.end};n.push(a),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}this._goNext("RightCurly"),this._checkCurrentTokenType("From")&&this._goNext("From");let i=this._parseLiteral();t={type:"ExportNamedDeclaration",specifiers:n,start:e,declaration:null,end:i.end,source:i}}else if(this._checkCurrentTokenType(["Const","Let","Var"])){let i=this._parseVariableDeclaration();return t={type:"ExportNamedDeclaration",declaration:i,start:e,end:i.end,specifiers:n,source:null},t}else if(this._checkCurrentTokenType("Function")){let i=this._parseFunctionDeclaration();t={type:"ExportNamedDeclaration",declaration:i,start:e,end:i.end,specifiers:n,source:null}}else{this._goNext("Asterisk");let i=null;this._checkCurrentTokenType("As")&&(this._goNext("As"),i=this._parseIdentifier()),this._goNext("From");let o=this._parseLiteral();t={type:"ExportAllDeclaration",start:e,end:o.end,source:o,exported:i}}if(!t)throw new Error("Export declaration cannot be parsed");return this._skipSemicolon(),t}_parseVariableDeclaration(){let{start:e}=this._getCurrentToken(),t=this._getCurrentToken().value;this._goNext(["Let","Var","Const"]);let n=[],i=()=>{if(this._checkCurrentTokenType("Semicolon"))return!0;let s=this._getNextToken();return!(s&&s.type==="Assign")};for(;!i();){let s=this._parseIdentifier(),a=null;this._checkCurrentTokenType("Assign")&&(this._goNext("Assign"),this._checkCurrentTokenType(["Number","StringLiteral"])?a=this._parseLiteral():a=this._parseExpression());let c={type:"VariableDeclarator",id:s,init:a,start:s.start,end:a?a.end:s.end};n.push(c),this._checkCurrentTokenType("Comma")&&this._goNext("Comma")}let o={type:"VariableDeclaration",kind:t,declarations:n,start:e,end:this._getPreviousToken().end};return this._skipSemicolon(),o}_parseReturnStatement(){let{start:e}=this._getCurrentToken();this._goNext("Return");let t=this._parseExpression(),n={type:"ReturnStatement",argument:t,start:e,end:t.end};return this._skipSemicolon(),n}_parseExpressionStatement(){let e=this._parseExpression();return{type:"ExpressionStatement",expression:e,start:e.start,end:e.end}}_parseExpression(){if(this._checkCurrentTokenType("Function"))return this._parseFunctionExpression();if(this._checkCurrentTokenType(["Number","StringLiteral"]))return this._parseLiteral();let e=this._parseIdentifier();for(;!this._isEnd();)if(this._checkCurrentTokenType("LeftParen"))e=this._parseCallExpression(e);else if(this._checkCurrentTokenType("Dot"))e=this._parseMemberExpression(e);else if(this._checkCurrentTokenType("Operator"))e=this.__parseBinaryOperatorExpression(e);else break;return e}__parseBinaryOperatorExpression(e){let{start:t}=this._getCurrentToken(),n=this._getCurrentToken().value;this._goNext("Operator");let i=this._parseExpression();return{type:"BinaryExpression",operator:n,left:e,right:i,start:t,end:i.end}}_parseMemberExpression(e){this._goNext("Dot");let t=this._parseIdentifier();return{type:"MemberExpression",object:e,property:t,start:e.start,end:t.end,computed:!1}}_parseCallExpression(e){let t=this._parseParams(1),{end:n}=this._getPreviousToken(),i={type:"CallExpression",callee:e,arguments:t,start:e.start,end:n};return this._skipSemicolon(),i}_parseFunctionDeclaration(){let{start:e}=this._getCurrentToken();this._goNext("Function");let t=null;this._checkCurrentTokenType("Identifier")&&(t=this._parseIdentifier());let n=this._parseParams(),i=this._parseBlockStatement();return{type:"FunctionDeclaration",id:t,params:n,body:i,start:e,end:i.end}}_parseFunctionExpression(){let{start:e}=this._getCurrentToken();this._goNext("Function");let t=null;this._checkCurrentTokenType("Identifier")&&(t=this._parseIdentifier());let n=this._parseParams(),i=this._parseBlockStatement();return{type:"FunctionExpression",id:t,params:n,body:i,start:e,end:i.end}}_parseParams(e=0){this._goNext("LeftParen");let t=[];for(;!this._checkCurrentTokenType("RightParen");){let n=e===0?this._parseIdentifier():this._parseExpression();t.push(n),this._checkCurrentTokenType("RightParen")||this._goNext("Comma")}return this._goNext("RightParen"),t}_parseLiteral(){let e=this._getCurrentToken(),t=e.value;e.type==="Number"&&(t=Number(t));let n={type:"Literal",value:e.value,start:e.start,end:e.end,raw:e.raw};return this._goNext(e.type),n}_parseIdentifier(){let e=this._getCurrentToken(),t={type:"Identifier",name:e.value,start:e.start,end:e.end};return this._goNext("Identifier"),t}_parseBlockStatement(){let{start:e}=this._getCurrentToken(),t={type:"BlockStatement",body:[],start:e,end:1/0};for(this._goNext("LeftCurly");!this._checkCurrentTokenType("RightCurly");){let n=this._parseStatement();t.body.push(n)}return t.end=this._getCurrentToken().end,this._goNext("RightCurly"),t}_checkCurrentTokenType(e){if(this._isEnd())return!1;let t=this._tokens[this._currentIndex];return Array.isArray(e)?e.includes(t.type):t.type===e}_skipSemicolon(){this._checkCurrentTokenType("Semicolon")&&this._goNext("Semicolon")}_goNext(e){let t=this._tokens[this._currentIndex];if(Array.isArray(e)){if(!e.includes(t.type))throw new Error(`Expect ${e.join(",")}, but got ${t.type}`)}else if(t.type!==e)throw new Error(`Expect ${e}, but got ${t.type}`);return this._currentIndex++,t}_isEnd(){return this._currentIndex>=this._tokens.length}_getCurrentToken(){return this._tokens[this._currentIndex]}_getPreviousToken(){return this._tokens[this._currentIndex-1]}_getNextToken(){return this._currentIndex+1<this._tokens.length?this._tokens[this._currentIndex+1]:!1}};function $(r){let t=new y(r).tokenize();return new I(t).parse()}var f=Object.keys,K=Object.values;var x=class{constructor(e,t,n){this.isFunctionDeclaration=!1;this.name=null;this.isParam=!1;this.isUsed=!1;this.isReassigned=!1;e&&(e.type==="FunctionDeclaration"?(this.isFunctionDeclaration=!0,this.functionNode=e):e.type==="VariableDeclarator"&&e.init&&/FunctionExpression/.test(e.init.type)&&(this.isFunctionDeclaration=!0,this.functionNode=e.init)),this.statement=n,this.isParam=t}addReference(e){e.declaration=this,this.name=e.name}use(){this.isUsed=!0,this.statement&&this.statement.mark()}render(){return this.name}},N=class extends x{constructor(t,n,i){super(t,!1,i);this.original=null,this.exportName="",this.name=n}render(){var t;return((t=this.original)==null?void 0:t.render())||this.name}bind(t){this.original=t}},T=class extends x{constructor(t){super(null,!1,null);this.originals={};this.needsNamespaceBlock=!1;this.module=t,t.getExports().forEach(n=>{let i=t.traceExport(n);i&&(this.originals[n]=i)})}addReference(t){if(this.needsNamespaceBlock||(this.needsNamespaceBlock=!0),t.objectPaths.length){let n=t.objectPaths.shift();t.name=n.name,t.start=n.start,t.end=n.end}K(this.originals).forEach(n=>{n.addReference(t)}),super.addReference(t)}renderBlock(t="  "){let n=f(this.originals).map(i=>{let o=this.originals[i];return`${t}${i}: ${o.render()}`}).join(`,
`);return`const ${this.render()} = Object.freeze({
${n}
});`}use(){for(let t of K(this.originals))t.use()}};var g=class{constructor(e){this.declarations={};let{parent:t,paramNodes:n,block:i,statement:o}=e;this.parent=t,this.paramNodes=n||[],this.statement=o,this.isBlockScope=!!i,this.paramNodes.forEach(s=>this.declarations[s.name]=new x(s,!0,this.statement))}addDeclaration(e,t){if(this.isBlockScope&&!t&&this.parent){this.parent.addDeclaration(e,t);return}let n=e.id&&e.id.name;this.declarations[n]=new x(e,!1,this.statement)}eachDeclaration(e){f(this.declarations).forEach(t=>{e(t,this.declarations[t])})}contains(e){return this.findDeclaration(e)}findDeclaration(e){return this.declarations[e]||this.parent&&this.parent.findDeclaration(e)}};function Z(r){return r?r.type==="FunctionDeclaration"||r.type==="VariableDeclarator"&&r.init&&r.init.type==="FunctionExpression"||(r.type==="ExportNamedDeclaration"||r.type==="ExportDefaultDeclaration")&&!!r.declaration&&r.declaration.type==="FunctionDeclaration":!1}function X(r){return/^Export/.test(r.type)}function Y(r){return r.type==="ImportDeclaration"}var G,E;function C(r,{enter:e,leave:t}){E=!1,U(r,null,e,t)}var ge={skip:()=>G=!0,abort:()=>E=!0},ee={},ye=Object.prototype.toString;function _e(r){return ye.call(r)==="[object Array]"}function U(r,e,t,n,i){if(!r||E||t&&(G=!1,t.call(ge,r,e,i),G||E))return;let o=ee[r.type]||(ee[r.type]=Object.keys(r).filter(c=>typeof r[c]=="object")),s,a;for(let c=0;c<o.length;c++)if(s=o[c],a=r[s],_e(a))for(let d=0;d<a.length;d++)U(a[d],r,t,n,s);else a&&a.type&&U(a,r,t,n,s);n&&!E&&n(r,e,i)}function te(r){let{node:e,scope:t}=r,n=t;C(e,{enter(i){if(i.type==="FunctionDeclaration"&&n.addDeclaration(i,!1),i.type==="VariableDeclaration"){let s=i,a=s.kind!=="var";s.declarations.forEach(c=>{n.addDeclaration(c,a)})}let o;if(i.type==="FunctionDeclaration"){let s=i;o=new g({parent:n,block:!1,paramNodes:s.params,statement:r})}i.type==="BlockStatement"&&(o=new g({parent:n,block:!0,statement:r})),o&&(Object.defineProperty(i,"_scope",{value:o,configurable:!0}),n=o)},leave(i){i._scope&&n.parent&&(n=n.parent)}})}var M=class{constructor(e,t,n){this.declaration=null;this.objectPaths=[];this.node=e,this.scope=t,this.statement=n,this.start=e.start,this.end=e.end;let i=e;for(this.objectPaths=[];i.type==="MemberExpression";)this.objectPaths.unshift(i.property),i=i.object;this.objectPaths.unshift(i),this.name=i.name}};function Ee(r,e){return r.type==="MemberExpression"&&e.type!=="MemberExpression"?!0:r.type==="Identifier"?!(e.type==="ExportSpecifier"&&r!==e.local):!1}function re(r){let{references:e,scope:t,node:n}=r,i=t;C(n,{enter(o,s){if(o._scope&&(i=o._scope),Ee(o,s)){let a=new M(o,i,r);e.push(a)}},leave(o){o._scope&&i.parent&&(i=i.parent)}})}var Tt=require("flatted"),v=class{constructor(e,t,n){this.isIncluded=!1;this.defines=new Set;this.modifies=new Set;this.dependsOn=new Set;this.references=[];this.magicString=t,this.node=e,this.module=n,this.scope=new g({statement:this}),this.start=e.start,this.next=0,this.isImportDeclaration=Y(e),this.isExportDeclaration=X(e),this.isReexportDeclaration=this.isExportDeclaration&&!!e.source,this.isFunctionDeclaration=Z(e)}analyse(){this.isImportDeclaration||(te(this),re(this))}mark(){this.isIncluded||(this.isIncluded=!0,this.references.forEach(e=>e.declaration&&e.declaration.use()))}};var w=class{constructor({path:e,bundle:t,code:n,loader:i,isEntry:o=!1}){this.isEntry=!1;this.exportAllSources=[];this.exportAllModules=[];this.dependencies=[];this.dependencyModules=[];this.referencedModules=[];this.id=e,this.bundle=t,this.moduleLoader=i,this.isEntry=o,this.path=e,this.code=n,this.magicString=new ne.default(n),this.imports={},this.exports={},this.reexports={},this.declarations={};try{let a=$(n).body;this.statements=a.map(c=>{let d=this.magicString.snip(c.start,c.end);return new v(c,d,this)})}catch(s){throw console.log(s),s}this.analyseAST()}analyseAST(){this.statements.forEach(n=>{n.analyse(),n.isImportDeclaration?(console.log(n,"import type"),this.addImports(n)):n.isExportDeclaration&&this.addExports(n),n.scope.parent||n.scope.eachDeclaration((i,o)=>{this.declarations[i]=o})});let e=this.statements,t=this.code.length;for(let n=e.length-1;n>=0;n--)e[n].next=t,t=e[n].start;console.log("module:",this.path),console.log("declaration\uFF1A",this.declarations),console.log("****************************"),this.statements.forEach(n=>{n.references.forEach(i=>{i.name})})}addDependencies(e){this.dependencies.includes(e)||this.dependencies.push(e)}addImports(e){let t=e.node,n=t.source.value;console.log("00000000"),console.log(n),console.log("00000000"),t.specifiers.forEach(i=>{let o=i.type==="ImportDefaultSpecifier",s=i.type==="ImportNamespaceSpecifier",a=i.local.name,c=o?"default":s?"*":i.imported.name;this.imports[a]={source:n,name:c,localName:a}}),console.log(this.imports,"\u6536\u96C6 imports"),this.addDependencies(n)}addExports(e){let t=e.node,n=t.source&&t.source.value;if(t.type==="ExportNamedDeclaration")if(t.specifiers.length)t.specifiers.forEach(i=>{let o=i.local.name,s=i.exported.name;this.exports[s]={localName:o,name:s},n&&(this.reexports[o]={statement:e,source:n,localName:o,name:o,module:void 0},this.imports[o]={source:n,localName:o,name:o},this.addDependencies(n))});else{let i=t.declaration,o;i.type==="VariableDeclaration"?o=i.declarations[0].id.name:o=i.id.name,this.exports[o]={statement:e,localName:o,name:o}}else if(t.type==="ExportDefaultDeclaration"){let i=t.declaration.id&&t.declaration.id.name||t.declaration.name;this.exports.default={statement:e,localName:i,name:"default"},this.declarations.default=new N(t,i,e)}else t.type==="ExportAllDeclaration"&&n&&(this.exportAllSources.push(n),this.addDependencies(n))}bind(){this.bindImportSpecifiers(),this.bindReferences()}bindImportSpecifiers(){[...Object.values(this.imports),...Object.values(this.reexports)].forEach(e=>{e.module=this._getModuleBySource(e.source)}),this.exportAllModules=this.exportAllSources.map(this._getModuleBySource.bind(this)),this.dependencyModules=this.dependencies.map(this._getModuleBySource.bind(this)),this.dependencyModules.forEach(e=>{e.referencedModules.push(this)})}bindReferences(){if(this.declarations.default&&this.exports.default.localName){let e=this.trace(this.exports.default.localName);e&&this.declarations.default.bind(e)}this.statements.forEach(e=>{e.references.forEach(t=>{let n=t.scope.findDeclaration(t.name)||this.trace(t.name);n&&n.addReference(t)})})}getOrCreateNamespace(){return this.declarations["*"]||(this.declarations["*"]=new T(this)),this.declarations["*"]}trace(e){if(this.declarations[e])return this.declarations[e];if(this.imports[e]){let t=this.imports[e],n=t.module;if(t.name==="*")return n.getOrCreateNamespace();let i=n.traceExport(t.name);if(i)return i}return null}traceExport(e){let t=this.reexports[e];if(t){let i=t.module.traceExport(t.localName);if(!i)throw new Error(`${t.localName} is not exported by module ${t.module.path}(imported by ${this.path})`);return i}if(this.exports[e]){let i=this.trace(e);if(i)return i}for(let i of this.exportAllModules){let o=i.trace(e);if(o)return o}return null}render(){let e=this.magicString.clone().trim();if(this.statements.forEach(t=>{if(!t.isIncluded){e.remove(t.start,t.next);return}if(t.references.forEach(n=>{let{start:i,end:o}=n,s=n.declaration;if(s){let a=s.render();e.overwrite(i,o,a)}}),t.isExportDeclaration&&!this.isEntry){if(t.node.type==="ExportNamedDeclaration"&&t.node.specifiers.length)e.remove(t.start,t.next);else if(t.node.type==="ExportNamedDeclaration"&&(t.node.declaration.type==="VariableDeclaration"||t.node.declaration.type==="FunctionDeclaration"))e.remove(t.node.start,t.node.declaration.start);else if(t.node.type==="ExportAllDeclaration")e.remove(t.start,t.next);else if(t.node.type==="ExportDefaultDeclaration"){let i=this.declarations.default.render();t.node.declaration.type==="FunctionDeclaration"?t.node.declaration.id?e.overwrite(t.node.start,t.node.declaration.start,`const ${i} = `):e.overwrite(t.node.start,t.node.declaration.start+8,`function ${i}`):e.overwrite(t.node.start,t.node.declaration.start,`const ${i} = `)}}}),this.declarations["*"]){let t=this.declarations["*"];t.needsNamespaceBlock&&e.append(`

${t.renderBlock()}
`)}return e.trim()}getExports(){return[...f(this.exports),...f(this.reexports),...this.exportAllModules.map(e=>e.getExports().filter(t=>t!=="default")).flat()]}_getModuleBySource(e){let t=this.moduleLoader.resolveId(e,this.path);return this.bundle.getModuleById(t)}};var m=require("path");function ie(r,e){return(0,m.isAbsolute)(r)?r:r.startsWith(".")?e?(0,m.resolve)((0,m.dirname)(e),r):(0,m.resolve)(r):!1}var oe=require("fs/promises"),R=class{constructor(e){this.resolveIdsMap=new Map;this.bundle=e}resolveId(e,t){let n=e+t;if(this.resolveIdsMap.has(n))return this.resolveIdsMap.get(n);let i=ie(e,t);return this.resolveIdsMap.set(n,i),i}async fetchModule(e,t,n=!1,i=this.bundle,o=this){let s=this.resolveId(e,t);if(s===!1)return null;let a=this.bundle.getModuleById(s);if(a)return a;let c=await(0,oe.readFile)(s,{encoding:"utf-8"}),d=new w({path:s,code:c,bundle:i,loader:o,isEntry:n});return this.bundle.addModule(d),await this.fetchAllDependencies(d),d}async fetchAllDependencies(e){await Promise.all(e.dependencies.map(t=>this.fetchModule(t,e.path)))}};var zt=require("flatted"),F=class{constructor(e){this.statements=[];this.modules=[];this.moduleById={};this.resolveIds={};this.orderedModules=[];let{entry:t,bundle:n}=e;this.entryPath=(0,B.resolve)(t),this.basedir=(0,B.dirname)(this.entryPath),this.bundle=n,this.moduleLoader=new R(n)}async build(){let e=await this.moduleLoader.fetchModule(this.entryPath,null,!0);this.modules.forEach(n=>n.bind()),this.orderedModules=this.sortModules(e),e.getExports().forEach(n=>{e.traceExport(n).use()}),this.modules.forEach(n=>{console.log("path:",n.path),console.log("decration deal:",n.declarations)}),this.doconflict();function t(n,i=2){let o=new WeakSet;return JSON.stringify(n,(s,a)=>{if(typeof a=="object"&&a!==null){if(o.has(a))return"[Circular Reference]";o.add(a)}return typeof a=="bigint"?a.toString()+"n":a instanceof Error?a.stack:a instanceof Map?Object.fromEntries(a):a instanceof Set?[...a]:a instanceof Date?a.toISOString():a},i)}}doconflict(){let e={};function t(n){let i=n,o=1;for(;e[i];)i=`${n}$${o++}`;return e[i]=!0,i}this.modules.forEach(n=>{f(n.declarations).forEach(i=>{let o=n.declarations[i];o.name=t(o.name)})})}getModuleById(e){return this.moduleById[e]}addModule(e){this.moduleById[e.id]||(this.moduleById[e.id]=e,this.modules.push(e))}sortModules(e){let t=[],n={},i={},o=[];function s(c,d){let k=[c],S=d;for(;S!==c;)k.push(S),S=i[S];return k.push(k[0]),k.reverse()}function a(c){if(!n[c.id]){for(let d of c.dependencyModules){if(i[d.id]){n[d.id]||o.push(s(d.id,c.id));continue}i[d.id]=c.id,a(d)}n[c.id]=!0,t.push(c)}}return a(e),o.length&&(o.forEach(c=>{console.log(c)}),process.exit(1)),t}};var L=class{constructor(e){this.graph=new F({entry:e.entry,bundle:this})}async build(){await this.graph.build()}getModuleById(e){return this.graph.getModuleById(e)}addModule(e){return this.graph.addModule(e)}render(){let e=new se.Bundle({separator:`
`});this.graph.orderedModules.forEach(n=>{e.addSource({content:n.render()})});let t=e.generateMap({includeContent:!0});return{code:e.toString(),map:t}}};var A=P(require("fs")),ce=require("path"),ke=r=>A.default.existsSync(r),Se=r=>new Promise((e,t)=>{let n=r.substring(0,r.lastIndexOf("/"));A.default.mkdir(n,{recursive:!0},i=>{i?t({success:!1}):e({success:!0})})}),ae=(r,e,t="utf-8")=>new Promise((n,i)=>{A.default.writeFile(r,e,{mode:438,flag:"w+",encoding:t},o=>{o?i({success:!1,data:o}):n({success:!0,data:{path:r,content:e}})})});function De(r){let{input:e="./index.js",output:t="./dist/index.js"}=r,n=new L({entry:e});return n.build().then(()=>{let i=()=>n.render();return{generate:i,write:async()=>{let{code:o,map:s}=i();return ke((0,ce.dirname)(t))||await Se(t),Promise.all([ae(t,o),ae(t+".map",s.toString())])}}})}0&&(module.exports={FunctionType,NodeType,ScanMode,TokenType,Tokenizer,parse,rollup});
